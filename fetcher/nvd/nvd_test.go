package nvd

import (
	"reflect"
	"testing"
	"time"

	"github.com/kotakanbe/go-cve-dictionary/models"
)

func TestDistributeCvesByYear(t *testing.T) {
	type args struct {
		uniqMap map[string]map[string]models.Nvd
		cves    map[string]models.Nvd
	}
	var tests = []struct {
		in       args
		expected map[string]map[string]models.Nvd
	}{
		{
			in: args{
				uniqMap: map[string]map[string]models.Nvd{},
				cves: map[string]models.Nvd{
					"CVE-2021-0001": {CveID: "CVE-2021-0001"},
					"CVE-2020-0001": {CveID: "CVE-2020-0001"},
				},
			},
			expected: map[string]map[string]models.Nvd{
				"2020": {
					"CVE-2020-0001": {CveID: "CVE-2020-0001"},
				},
				"2021": {
					"CVE-2021-0001": {CveID: "CVE-2021-0001"},
				},
			},
		},
		{
			in: args{
				uniqMap: map[string]map[string]models.Nvd{
					"2021": {
						"CVE-2021-0001": {CveID: "CVE-2021-0001", LastModifiedDate: time.Date(2021, time.September, 3, 0, 0, 0, 0, time.UTC)},
					},
				},
				cves: map[string]models.Nvd{
					"CVE-2021-0001": {CveID: "CVE-2021-0001", LastModifiedDate: time.Date(2021, time.September, 4, 0, 0, 0, 0, time.UTC)},
				},
			},
			expected: map[string]map[string]models.Nvd{
				"2021": {
					"CVE-2021-0001": {CveID: "CVE-2021-0001", LastModifiedDate: time.Date(2021, time.September, 4, 0, 0, 0, 0, time.UTC)},
				},
			},
		},
	}

	for i, tt := range tests {
		distributeCvesByYear(tt.in.uniqMap, tt.in.cves)
		if !reflect.DeepEqual(tt.in.uniqMap, tt.expected) {
			t.Errorf("[%d] expected: %v\n  actual: %v\n", i, tt.expected, tt.in.uniqMap)
		}
	}
}
